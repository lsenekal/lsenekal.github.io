<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disney Style Character Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Light gray background */
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-5xl mx-auto flex flex-col lg:flex-row gap-8">

        <!-- Input Card --><div class="lg:w-1/2 w-full bg-white p-6 rounded-xl card border border-gray-100">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Character Creator</h1>
            <p class="text-gray-600 mb-6">Upload a photo of a person to transform it into a **Disney-Pixar style character**.</p>
            
            <label for="photo-input" class="block text-sm font-medium text-gray-700 mb-2">1. Upload Photo (Portrait recommended)</label>
            <input type="file" id="photo-input" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100 mb-4" onchange="previewImage()">

            <!-- Image Preview --><div class="h-64 bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300 mb-6">
                <img id="image-preview" src="" alt="Photo Preview" class="max-h-full max-w-full object-contain hidden rounded-lg">
                <p id="preview-text" class="text-gray-500">Preview will appear here</p>
            </div>

            <button onclick="generateDisneyCharacter()" id="generate-btn" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold btn-primary hover:bg-indigo-700 disabled:opacity-50">
                Generate Disney Character
            </button>

            <div id="error-message" class="text-red-500 mt-4 hidden p-3 bg-red-50 rounded-lg"></div>
        </div>

        <!-- Output Card --><div class="lg:w-1/2 w-full bg-white p-6 rounded-xl card border border-gray-100 flex flex-col items-center justify-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2 w-full">Generated Output</h2>
            
            <!-- Loading Spinner --><div id="loading-spinner" class="hidden flex flex-col items-center justify-center h-full w-full py-16">
                <svg class="animate-spin h-10 w-10 text-indigo-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-indigo-600 font-semibold">Generating character... Please wait.</p>
                <p class="text-sm text-gray-500 mt-1">This may take up to 30 seconds.</p>
            </div>
            
            <!-- Result Image --><div id="result-container" class="h-full w-full flex items-center justify-center min-h-[300px]">
                <img id="result-image" src="" alt="Generated Disney Character" class="max-h-full max-w-full object-contain rounded-lg shadow-lg">
                <p id="initial-message" class="text-gray-500">Your generated character will appear here.</p>
            </div>
            
            <!-- Download Button --><a id="download-btn" href="#" download="disney_character.png" class="mt-4 bg-green-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600 hidden disabled:opacity-50">Download Image</a>
        </div>
        
    </div>

    <script>
        // API Configuration (Mandatory global variables provided by the environment)
        const apiKey = "AIzaSyB9szLkUYPkTcyim4eK78xYOdhkVsmerSk";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
        const MAX_RETRIES = 5;
        const INITIAL_BACKOFF_MS = 1000;

        // UI Elements
        const input = document.getElementById('photo-input');
        const preview = document.getElementById('image-preview');
        const previewText = document.getElementById('preview-text');
        const resultImage = document.getElementById('result-image');
        const loadingSpinner = document.getElementById('loading-spinner');
        const generateBtn = document.getElementById('generate-btn');
        const errorMessage = document.getElementById('error-message');
        const initialMessage = document.getElementById('initial-message');
        const downloadBtn = document.getElementById('download-btn');

        // --- Helper Functions ---

        function showLoading(isLoading) {
            loadingSpinner.classList.toggle('hidden', !isLoading);
            generateBtn.disabled = isLoading;
            generateBtn.textContent = isLoading ? 'Processing...' : 'Generate Disney Character';
            errorMessage.classList.add('hidden');
            initialMessage.classList.toggle('hidden', isLoading);
            downloadBtn.classList.add('hidden');
        }

        function displayError(message) {
            errorMessage.textContent = 'Error: ' + message;
            errorMessage.classList.remove('hidden');
            resultImage.src = '';
            resultImage.classList.add('hidden');
            initialMessage.classList.remove('hidden');
            downloadBtn.classList.add('hidden');
        }

        function previewImage() {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    previewText.classList.add('hidden');
                    generateBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            } else {
                preview.classList.add('hidden');
                previewText.classList.remove('hidden');
                generateBtn.disabled = true;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Extract only the Base64 data (part after the comma)
                    const base64Data = reader.result.split(',')[1];
                    resolve(base64Data);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // --- Main Generation Logic ---

        async function generateDisneyCharacter() {
            const file = input.files[0];
            if (!file) {
                displayError('Please upload an image file first.');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                 displayError('Image size must be less than 5MB.');
                return;
            }

            showLoading(true);

            try {
                const base64Data = await fileToBase64(file);
                const mimeType = file.type;

                // --- Detailed Prompt for Style Control ---
                const systemPrompt = "You are a world-class 3D character artist specializing in modern Disney/Pixar style animation. Your task is to convert the provided real human photo into a highly detailed, smooth-rendered 3D animated character.";

                // UPDATED userQuery to emphasize both eyes looking directly at the camera.
                const userQuery = `Convert the provided real human photo into a **fully rendered 3D Disney-Pixar style character**. The character must be a **full-body portrait** and should be standing in a **casual, happy, and playful pose** (e.g., hands on hips, a slight lean). **Crucially, the legs must never be crossed, both eyes must be looking in the same direction directly at the camera/viewer, and the eye color must remain exactly the same as in the original photo.** The **background must be completely cleared and solid white**. Only the character should be visible. Maintain the overall likeness, hair, and clothing style of the person in the photo, but strictly apply the highly detailed, stylized, smooth rendering of the Disney/Pixar aesthetic.`;
                // --- End Prompt ---
                
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: userQuery },
                                {
                                    inlineData: {
                                        mimeType: mimeType,
                                        data: base64Data
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseModalities: ['TEXT', 'IMAGE']
                    },
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    }
                };

                // Use exponential backoff for resilience
                let response, result;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            result = await response.json();
                            break; // Success
                        } else if (response.status === 429 && i < MAX_RETRIES - 1) {
                            const delay = INITIAL_BACKOFF_MS * Math.pow(2, i) + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            console.log(`Retrying after ${delay}ms...`);
                        } else {
                            throw new Error(`API failed with status ${response.status}: ${response.statusText}`);
                        }
                    } catch (e) {
                        if (i === MAX_RETRIES - 1) throw e;
                        const delay = INITIAL_BACKOFF_MS * Math.pow(2, i) + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        console.log(`Retrying after error ${e.message}...`);
                    }
                }

                if (!result || !result.candidates || result.candidates.length === 0) {
                    displayError('Failed to generate image. Please try again.');
                    return;
                }

                const imagePart = result.candidates[0].content.parts.find(p => p.inlineData && p.inlineData.mimeType.startsWith('image/'));
                
                if (imagePart) {
                    const generatedBase64Data = imagePart.inlineData.data;
                    const imageUrl = `data:${imagePart.inlineData.mimeType};base64,${generatedBase64Data}`;
                    
                    resultImage.src = imageUrl;
                    resultImage.classList.remove('hidden');
                    initialMessage.classList.add('hidden');
                    
                    // Enable Download
                    downloadBtn.href = imageUrl;
                    downloadBtn.classList.remove('hidden');

                } else {
                    displayError('Generation failed. No image output received. The prompt might have been rejected.');
                    console.error("Full API response:", result);
                }

            } catch (error) {
                console.error("An unexpected error occurred:", error);
                displayError('An unexpected error occurred during generation: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html>
